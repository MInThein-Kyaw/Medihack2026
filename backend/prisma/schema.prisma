generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String    @id @default(uuid())
  username        String    @unique
  email           String?   @unique
  passwordHash    String
  experienceYears Int
  level           Int
  standardScore   Float
  department      String?
  createdAt       DateTime  @default(now())
  lastLogin       DateTime?
  
  sessions        AssessmentSession[]
  results         AssessmentResult[]
  idpPlans        IDPPlan[]
  progress        ProgressTracking[]
  
  @@map("users")
}

model AssessmentSession {
  id                String    @id @default(uuid())
  userId            String
  startedAt         DateTime  @default(now())
  completedAt       DateTime?
  status            String    // in_progress, completed, abandoned
  language          String    // th, en
  totalCompetencies Int
  completedCount    Int       @default(0)
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  results           AssessmentResult[]
  
  @@map("assessment_sessions")
}

model AssessmentResult {
  id              String    @id @default(uuid())
  sessionId       String
  userId          String
  competencyId    String
  competencyName  String
  score           Float
  gap             Float
  feedback        String    @db.Text
  createdAt       DateTime  @default(now())
  
  session         AssessmentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  responses       QuestionResponse[]
  idpPlan         IDPPlan?
  
  @@map("assessment_results")
}

model QuestionResponse {
  id                  String   @id @default(uuid())
  assessmentResultId  String
  questionNumber      Int
  scenarioText        String   @db.Text
  userResponse        String   @db.Text
  timestamp           DateTime @default(now())
  
  assessmentResult    AssessmentResult @relation(fields: [assessmentResultId], references: [id], onDelete: Cascade)
  
  @@map("question_responses")
}

model IDPPlan {
  id                    String   @id @default(uuid())
  assessmentResultId    String   @unique
  userId                String
  trainingCourses       String[] // JSON array
  nonTrainingCourses    String[] // JSON array
  recommendation        String   @db.Text
  createdAt             DateTime @default(now())
  reviewedBySupervisor  Boolean  @default(false)
  
  assessmentResult      AssessmentResult @relation(fields: [assessmentResultId], references: [id], onDelete: Cascade)
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("idp_plans")
}

model ProgressTracking {
  id              String    @id @default(uuid())
  userId          String
  competencyId    String
  assessmentCount Int       @default(1)
  firstScore      Float
  latestScore     Float
  improvementTrend Float    @default(0)
  lastAssessedAt  DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, competencyId])
  @@map("progress_tracking")
}
